package eshore.cn.it.gate;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;

import org.apache.log4j.Logger;

import gate.AnnotationSet;
import gate.Corpus;
import gate.CorpusController;
import gate.Document;
import gate.Factory;
import gate.FeatureMap;
import gate.Gate;
import gate.annotation.AnnotationImpl;
import gate.creole.ANNIEConstants;
import gate.creole.ConditionalSerialAnalyserController;
import gate.creole.ResourceInstantiationException;
import gate.util.GateException;
import gate.util.Out;
import gate.util.persistence.PersistenceManager;

/**
 * class<code>GateStart</code>此类演示了如何利用GATE实现批量信息抽取
 *
 * @author   clebeg
 * @version	 0.0.1
 * @see      java.lang.Class
 * @since    JDK1.8
 * */
public class GateStart {
	private static Logger logger = 
			Logger.getLogger(GateStart.class.getName());
	
	//指定GATE安装目录
	private String gateHome = "F:\\java\\GATE_Developer_8.0";
	//指定注册的plugin名字
	private String pluginName = "Lang_Chinese";
	//指定使用的资源类名
	private String resourceClassName;
	
	//定义基于语料库的GATE控制者
	private CorpusController controller;
	
	
	
	public void controllerExecute() throws Exception {
		setGateHome();
		gateInit();
		

		// initialise ANNIE (this may take several minutes)
		initController();

		// create a GATE corpus and add a document for each command-line
		// argument
		Corpus corpus = (Corpus) Factory.createResource("gate.corpora.CorpusImpl");
		// for(int i = 0; i < args.length; i++) {
		// URL u = new URL(args[i]);
//		URL u = new URL("file:/d:\\corpus\\corpusedFile.txt");
		StringBuffer corpusDir = new StringBuffer("");
		corpusDir.append("file:/").append(System.getProperty("user.dir")).append("\\corpusedFile.txt");
		URL u = new URL(corpusDir.toString());
		FeatureMap params = Factory.newFeatureMap();
		params.put("sourceUrl", u);
		params.put("preserveOriginalContent", new Boolean(true));
		params.put("collectRepositioningInfo", new Boolean(true));
		params.put("encoding", "UTF-8");//以UTF-8编码读取信息 否则会出现乱码
		Out.prln("Creating doc for " + u);
		Document docs = (Document) Factory.createResource("gate.corpora.DocumentImpl", params);
		corpus.add(docs);
		// } // for each of args

		// tell the pipeline about the corpus and run it
		controller.setCorpus(corpus);
		controller.execute();
		doSometings(docs);
		//标注完成输出结果
		//@SuppressWarnings("resource")
		//FileWriter writer = new FileWriter(new File("test.xml"));
		//writer.write(docs.toXml());
	}
	
	
	private void gateInit() {
		Gate.init();
		
		File gateHome = Gate.getGateHome();
		File pluginsHome = new File(gateHome, "plugins");
		Gate.getCreoleRegister().registerDirectories(new File(pluginsHome, this.pluginName).toURI().toURL());
		
		Out.prln("...GATE initialised");
	}


	private static void doSometings(Document docs) throws ResourceInstantiationException {
		AnnotationSet annSet = docs.getAnnotations();
		
		String type = "Date";
		
		AnnotationSet persSet = annSet.get(type);
		List persList = new ArrayList(persSet);
		Collections.sort(persList , new gate.util.OffsetComparator());
		Iterator persIter = persList.iterator();
		while(persIter.hasNext()) {
			AnnotationImpl impl = (AnnotationImpl)persIter.next();
			
		}
	}

	private void setGateHome() {
		System.setProperty("gate.home", this.gateHome);
		logger.info("The GATE_HOME directory is:" + (System.getProperties().getProperty("gate.home")));
	}
	
	private void initController() throws GateException, IOException {
		Out.prln("Initialising CHNIE...");
		//chnController = (ConditionalSerialAnalyserController) PersistenceManager.loadObjectFromFile(new File(new File(Gate.getPluginsHome(),"Lang_Chinese"), "resources/chinese.gapp"));
		controller = (ConditionalSerialAnalyserController)
				PersistenceManager.loadObjectFromFile(new File(new File(
				Gate.getPluginsHome(), ANNIEConstants.PLUGIN_DIR),
				ANNIEConstants.DEFAULT_FILE));
		Out.prln("...CHNIE loaded");
	} 
}
